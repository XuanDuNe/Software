version: '3.8'

services:
  # API Gateway
  gateway:
    build: ./gateway
    ports:
      - "8000:8000"
    depends_on:
      - auth-service
      - opportunity-service
      - application-service
      - notification-service
      - matching-service

  # Auth Service
  auth-service:
    build: ./services/auth-service
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql://postgres:12345678@postgres-auth:5432/auth_db
    depends_on:
      postgres-auth:
        condition: service_healthy

  postgres-auth:
    image: postgres:15
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 12345678
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Opportunity Service
  opportunity-service:
    build: ./services/opportunity-service
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres-opportunity:5432/opportunity_db
    depends_on:
      - postgres-opportunity

  postgres-opportunity:
    image: postgres:15
    environment:
      POSTGRES_DB: opportunity_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass

  # Application Service
  application-service:
    build: ./services/application-service
    ports:
      - "8004:8004"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres-application:5432/application_db
    depends_on:
      - postgres-application

  postgres-application:
    image: postgres:15
    environment:
      POSTGRES_DB: application_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass

  # Notification Service
  notification-service:
    build: ./services/notification-service
    ports:
      - "8005:8005"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres-notification:5432/notification_db
    depends_on:
      - postgres-notification
  
  postgres-notification:
    image: postgres:15
    environment:
      POSTGRES_DB: notification_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass

  # Matching (AI Recommendation) Service
  matching-service:
    build: ./services/matching-service
    ports:
      - "8007:8007"