<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduMatch - Test Platform (Comprehensive)</title>
    <style>
        /* ------------------- BASE STYLES ------------------- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f0f2f5; /* Light gray background */
            color: #333;
        }
        
        h1 { 
            color: #007bff; /* Primary blue */
            border-bottom: 3px solid #007bff; 
            padding-bottom: 10px; 
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        h2 { 
            color: #333; 
            font-size: 1.5rem; 
            margin-top: 0;
        }

        /* ------------------- LAYOUT ------------------- */
        .container { 
            display: flex; 
            gap: 20px; 
            align-items: flex-start; /* Align items to the top */
        }
        
        .main-content {
            flex: 3; /* Chi·∫øm 3/4 chi·ªÅu r·ªông */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .side-column { 
            flex: 1; /* Chi·∫øm 1/4 chi·ªÅu r·ªông */
            flex-direction: column;
            gap: 20px;
            min-width: 280px;
        }

        .card { 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Modern shadow */
            padding: 20px; 
            border: 1px solid #e0e0e0;
        }
        
        /* ------------------- INPUTS & BUTTONS ------------------- */
        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        select, 
        textarea, 
        input[type="date"],
        input[type="number"] {
            width: calc(100% - 20px); 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #ccc; 
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        textarea {
            min-height: 80px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        button {
            padding: 10px 15px; 
            border: none; 
            border-radius: 6px; 
            background-color: #007bff; 
            color: white; 
            cursor: pointer; 
            margin-top: 5px;
            margin-right: 8px;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover { 
            background-color: #0056b3; 
            transform: translateY(-1px);
        }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        button.success { background-color: #28a745; }
        button.success:hover { background-color: #1e7e34; }


        /* ------------------- OUTPUT & STATUS ------------------- */
        pre { 
            background: #2d2d2d; /* Dark background for code/JSON */
            color: #f8f8f2;
            padding: 15px; 
            border-radius: 6px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-size: 13px; 
            overflow-x: auto;
            margin-top: 10px;
        }
        #ws-messages { 
            max-height: 250px; 
            overflow-y: auto; 
            font-size: 12px;
            background: #f8f8f8;
            color: #333;
        }
        .hidden { display: none; }
        #user-info { 
            background: #e6f2ff; /* Light blue for user info */
            border: 1px solid #b3d9ff; 
            padding: 15px; 
            border-radius: 6px; 
            margin-bottom: 15px;
        }
        #ws-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: 600;
            background-color: #fff3cd;
            color: #856404;
        }
        .service-map { font-size: 0.9rem; line-height: 1.8; }
        .service-map code { 
            background-color: #e9ecef; 
            padding: 2px 5px; 
            border-radius: 4px;
            color: #333;
        }
    </style>
</head>
<body>

    <h1>üöÄ EduMatch - Test Platform (Gateway: <code id="gateway-url"></code>)</h1>

    <div class="container">
        
        <div class="main-content">
            <div class="card">
                <h2>üîë X√°c th·ª±c & Th√¥ng b√°o Real-time</h2>
                
                <div id="login-form">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" placeholder="e.g., student@email.com" value="student@email.com">
                    
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" placeholder="Password" value="123456">
                    
                    <button onclick="login()" class="success">ƒêƒÉng nh·∫≠p</button>
                    <button class="secondary" onclick="register()">ƒêƒÉng k√Ω (M√¥ ph·ªèng)</button>
                </div>
                
                <div id="user-info" class="hidden">
                    <h3>üë§ User ƒë√£ ƒëƒÉng nh·∫≠p</h3>
                    <pre id="user-display"></pre>
                    <button class="danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>

                <hr style="margin: 15px 0;">

                <h3>üí¨ WebSocket Status</h3>
                <div id="ws-status">Ch∆∞a k·∫øt n·ªëi. (H√£y ƒëƒÉng nh·∫≠p)</div>
                <pre id="ws-messages"></pre>
            </div>
            
            <div id="student-section" class="card hidden">
                <h2>üéì Student Actions (Application Service)</h2>
                
                <div style="border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3>üîç Xem Opportunities</h3>
                    <button onclick="getAllOpportunities()">T·∫£i t·∫•t c·∫£ Opportunities</button>
                    <pre id="student-opps"></pre>
                </div>
                
                <div style="border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3>üìù N·ªôp Application (k√®m CV)</h3>
                    <label for="apply-opp-id">Opportunity ID mu·ªën n·ªôp:</label>
                    <input type="number" id="apply-opp-id" placeholder="ID Opportunity">
                    
                    <label for="apply-cv-file">Ch·ªçn file CV:</label>
                    <input type="file" id="apply-cv-file" accept=".pdf,.doc,.docx" style="width: 100%; margin-bottom: 15px;">
                    
                    <button onclick="submitApplication()">N·ªôp Application & Upload File</button>
                </div>
                
                <div>
                    <h3>üìÑ H·ªì s∆° ƒë√£ n·ªôp c·ªßa t√¥i</h3>
                    <button onclick="getMyApplications()">Xem h·ªì s∆° ƒë√£ n·ªôp</button>
                    <pre id="student-apps"></pre>
                </div>
            </div>

            <div id="provider-section" class="card hidden">
                <h2>üíº Provider Actions (Opportunity Service)</h2>
                
                <div style="border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3>‚ú® T·∫°o Opportunity m·ªõi</h3>
                    <label for="opp-title">T√™n c∆° h·ªôi:</label>
                    <input type="text" id="opp-title" placeholder="T√™n h·ªçc b·ªïng, kh√≥a h·ªçc..." value="H·ªçc b·ªïng ABC">
                    
                    <label for="opp-description">M√¥ t·∫£:</label>
                    <textarea id="opp-description" placeholder="M√¥ t·∫£ chi ti·∫øt c∆° h·ªôi..."></textarea>
                    
                    <label for="opp-type">Lo·∫°i:</label>
                    <select id="opp-type">
                        <option value="scholarship">H·ªçc b·ªïng</option>
                        <option value="research_lab">Ph√≤ng lab nghi√™n c·ª©u</option>
                        <option value="program">Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o/kh√°c</option>
                    </select>

                    <label for="opp-criteria-gpa">GPA t·ªëi thi·ªÉu:</label>
                    <input type="number" step="0.01" id="opp-criteria-gpa" placeholder="V√≠ d·ª•: 3.0">

                    <label for="opp-required-skills">K·ªπ nƒÉng y√™u c·∫ßu (ph√¢n c√°ch b·ªüi d·∫•u ph·∫©y):</label>
                    <input type="text" id="opp-required-skills" placeholder="Python, Machine Learning, Ti·∫øng Anh" value="Python, ML">

                    <label for="opp-deadline">H·∫°n ch√≥t:</label>
                    <input type="date" id="opp-deadline" value="2025-12-31">

                    <label for="opp-required-docs">T√†i li·ªáu y√™u c·∫ßu (ph√¢n c√°ch b·ªüi d·∫•u ph·∫©y):</label>
                    <input type="text" id="opp-required-docs" placeholder="CV, B·∫£ng ƒëi·ªÉm, Th∆∞ gi·ªõi thi·ªáu..." value="CV, B·∫£ng ƒëi·ªÉm">

                    <button onclick="createOpportunity()">T·∫°o Opportunity</button>
                </div>
                
                <div style="border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3>üì• Qu·∫£n l√Ω Applications ƒë√£ nh·∫≠n</h3>
                    <button onclick="getReceivedApplications()">T·∫£i danh s√°ch h·ªì s∆°</button>
                    <pre id="provider-apps"></pre>
                </div>
                
                <div>
                    <h3>üîÑ C·∫≠p nh·∫≠t tr·∫°ng th√°i H·ªì s∆°</h3>
                    <label for="update-app-id">Application ID:</label>
                    <input type="number" id="update-app-id" placeholder="Nh·∫≠p Application ID">
                    <label for="update-status">Tr·∫°ng th√°i m·ªõi:</label>
                    <select id="update-status">
                        <option value="viewed">Viewed</option>
                        <option value="interview">Interview</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button onclick="updateAppStatus()">C·∫≠p nh·∫≠t Status</button>
                </div>
            </div>

             <div id="common-section" class="card hidden">
                <h2>üîî L·ªãch s·ª≠ th√¥ng b√°o DB (Notification Service)</h2>
                 <button onclick="getDbNotifications()">T·∫£i My DB Notifications</button>
                 <pre id="db-notifications"></pre>
            </div>
        </div>
        
        <div class="side-column">
             <div class="card">
                <h2>üìö T√†i li·ªáu K·ªπ thu·∫≠t</h2>
                <h3>C·∫•u tr√∫c Service Ports</h3>
                <div class="service-map">
                    <ul>
                        <li>**API Gateway:** <code>:8000</code> (Proxy)</li>
                        <li>**Auth Service:** <code>:8001</code></li>
                        <li>**Application Service:** <code>:8004</code></li>
                        <li>**Notification Service:** <code>:8005</code> (HTTP/WS)</li>
                        <li>**Provider Service:** <code>:8006</code></li>
                        <li>**Matching Service:** <code>:8007</code> (TBD)</li>
                    </ul>
                </div>
                <hr>
                <h3>Gateway Endpoint Map</h3>
                <div class="service-map">
                    <p><code>/auth/*</code> &rarr; Auth Service (<code>:8001</code>)</p>
                    <p><code>/application/*</code> &rarr; Application Service (<code>:8004</code>)</p>
                    <p><code>/notification/*</code> &rarr; Notification Service (<code>:8005</code>)</p>
                    <p><code>/opportunity/*</code> &rarr; Provider Service (<code>:8006</code>)</p>
                    <p><code>/provider_app/*</code> &rarr; Provider Service (<code>:8006</code>)</p>
                    <p>WS Direct: <code>ws://localhost:8005/ws/{user_id}</code></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // C·ªïng m·∫∑c ƒë·ªãnh
        const GATEWAY_BASE = "http://localhost:8000";
        const WS_NOTIFICATION_SERVICE_BASE = "ws://localhost:8005"; 
        document.getElementById('gateway-url').textContent = GATEWAY_BASE;

        let currentUser = null;
        let ws = null;

        // --- AUTH ---
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                // 1. Login to get token
                const res = await fetch(`${GATEWAY_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Login failed');
                
                localStorage.setItem('token', data.access_token);
                
                // 2. Verify token to get user info
                await fetchUserData(data.access_token);

            } catch (e) {
                logMessage('ws-messages', `Auth Error: ${e.message}`, 'error');
            }
        }
        
        async function register() {
            alert('Ch·ª©c nƒÉng ƒëƒÉng k√Ω m√¥ ph·ªèng: ƒê·∫£m b·∫£o user "student@email.com" (role=student) v√† "provider@email.com" (role=provider) ƒë√£ t·ªìn t·∫°i trong DB.');
        }

        async function fetchUserData(token) {
             try {
                const res = await fetch(`${GATEWAY_BASE}/auth/verify-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Verify failed');

                currentUser = {
                    id: data.user_id,
                    email: data.email,
                    role: data.role,
                    token: token
                };
                localStorage.setItem('user', JSON.stringify(currentUser));
                updateUIForUser();
                connectWebSocket();
            } catch (e) {
                 logMessage('ws-messages', `Auth Error: ${e.message}`, 'error');
                 logout();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            currentUser = null;
            if (ws) ws.close();
            updateUIForUser();
            logMessage('ws-messages', 'ƒê√£ ƒëƒÉng xu·∫•t.', 'info');
        }

        // --- UI UPDATES ---
        function updateUIForUser() {
            if (currentUser) {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-display').textContent = JSON.stringify(currentUser, null, 2);
                document.getElementById('common-section').classList.remove('hidden');

                if (currentUser.role === 'provider') {
                    document.getElementById('provider-section').classList.remove('hidden');
                    document.getElementById('student-section').classList.add('hidden');
                    // Set default email for easy switching
                    document.getElementById('login-email').value = 'provider@email.com'; 
                } else if (currentUser.role === 'student') {
                    document.getElementById('provider-section').classList.add('hidden');
                    document.getElementById('student-section').classList.remove('hidden');
                    // Set default email for easy switching
                    document.getElementById('login-email').value = 'student@email.com'; 
                }
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('provider-section').classList.add('hidden');
                document.getElementById('student-section').classList.add('hidden');
                document.getElementById('common-section').classList.add('hidden');
            }
        }

        // --- WEBSOCKET ---
        function connectWebSocket() {
            if (!currentUser) return;
            if (ws) ws.close();

            // Endpoint: /ws/{user_id} (t·ª´ notification-service/main.py)
            const wsUrl = `${WS_NOTIFICATION_SERVICE_BASE}/ws/${currentUser.id}`;
            ws = new WebSocket(wsUrl);
            
            const wsStatus = document.getElementById('ws-status');
            
            ws.onopen = () => {
                wsStatus.textContent = `‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket cho user ${currentUser.id} (t·∫°i ${wsUrl})`;
                wsStatus.style.backgroundColor = '#d4edda';
                wsStatus.style.color = '#155724';
                logMessage('ws-messages', `[WS] Connected to ${wsUrl}`, 'success');
            };
            ws.onmessage = (event) => {
                logMessage('ws-messages', `[WS] RECV: ${event.data}`, 'info');
            };
            ws.onerror = (event) => {
                wsStatus.textContent = '‚ùå L·ªói WebSocket.';
                wsStatus.style.backgroundColor = '#f8d7da';
                wsStatus.style.color = '#721c24';
                logMessage('ws-messages', `[WS] Error: ${JSON.stringify(event)}`, 'error');
            };
            ws.onclose = () => {
                wsStatus.textContent = 'üîå ƒê√£ ng·∫Øt k·∫øt n·ªëi WebSocket.';
                wsStatus.style.backgroundColor = '#fefefe';
                wsStatus.style.color = '#6c757d';
                logMessage('ws-messages', '[WS] Disconnected.', 'error');
                ws = null;
            };
        }

        // --- API HELPERS ---
        async function fetchWithAuth(url, options = {}) {
            if (!currentUser) throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p');
            
            const headers = {
                'Authorization': `Bearer ${currentUser.token}`,
                ...options.headers,
            };

            // Set Content-Type only if not multipart/form-data
            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }

            const res = await fetch(url, { ...options, headers });
            const text = await res.text();
            
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                // If it fails to parse, return raw text or a status message
                data = { raw: text, message: `Raw response (status ${res.status}): ${text}` };
            }

            if (!res.ok) {
                // Return server detail if available, otherwise raw text
                throw new Error(data.detail || data.raw || `HTTP Error ${res.status}`);
            }
            return data;
        }
        
        function logMessage(preId, message, type = 'info') {
            const pre = document.getElementById(preId);
            const line = document.createElement('div');
            line.textContent = message;
            // Clear old messages if too many (for performance)
            if (pre.children.length > 50) {
                pre.removeChild(pre.firstChild);
            }

            if (type === 'error') line.style.color = '#dc3545';
            else if (type === 'success') line.style.color = '#28a745';
            else if (type === 'info') line.style.color = '#007bff';
            
            pre.appendChild(line);
            pre.scrollTop = pre.scrollHeight;
        }

        // --- PROVIDER ACTIONS ---
        async function createOpportunity() {
            try {
                const title = document.getElementById('opp-title').value;
                const description = document.getElementById('opp-description').value;
                const type = document.getElementById('opp-type').value;
                const gpaMin = document.getElementById('opp-criteria-gpa').value;
                const requiredSkills = document.getElementById('opp-required-skills').value
                                        .split(',')
                                        .map(doc => doc.trim())
                                        .filter(doc => doc !== '');
                const deadline = document.getElementById('opp-deadline').value;
                const requiredDocs = document.getElementById('opp-required-docs').value
                                        .split(',')
                                        .map(doc => doc.trim())
                                        .filter(doc => doc !== '');

                // Endpoint: /opportunity/ (map t·ªõi provider-service:8006/api/opportunities/)
                const oppData = await fetchWithAuth(`${GATEWAY_BASE}/opportunity/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        provider_user_id: currentUser.id,
                        title: title,
                        description: description,
                        type: type, 
                    })
                });

                // T·∫°o/C·∫≠p nh·∫≠t Criteria
                const criteriaData = {
                    gpa_min: gpaMin ? parseFloat(gpaMin) : null,
                    skills: requiredSkills,
                    deadline: deadline,
                    required_documents: requiredDocs
                };

                 const data = await fetchWithAuth(`${GATEWAY_BASE}/opportunity/${oppData.id}/criteria`, {
                    method: 'POST',
                    body: JSON.stringify(criteriaData)
                });

                alert(`‚úÖ T·∫°o th√†nh c√¥ng Opportunity ID: ${oppData.id} v√† Criteria.`);
            } catch (e) {
                alert(`‚ùå L·ªói: ${e.message}`);
            }
        }
        
        async function getReceivedApplications() {
             try {
                // Endpoint: /provider_app/provider/{user_id} (map t·ªõi provider-service:8006/api/applications/provider/{user_id})
                const data = await fetchWithAuth(`${GATEWAY_BASE}/provider_app/provider/${currentUser.id}`);
                
                // Hi·ªÉn th·ªã chi ti·∫øt Application, bao g·ªìm documents (CV URL)
                document.getElementById('provider-apps').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('provider-apps').textContent = `‚ùå L·ªói: ${e.message}`;
            }
        }
        
        async function updateAppStatus() {
            try {
                const appId = document.getElementById('update-app-id').value;
                const status = document.getElementById('update-status').value;
                if (!appId) {
                    alert('Vui l√≤ng nh·∫≠p Application ID');
                    return;
                }
                
                // Endpoint: /provider_app/{app_id}/status (map t·ªõi provider-service:8006/api/applications/{app_id}/status)
                const data = await fetchWithAuth(`${GATEWAY_BASE}/provider_app/${appId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: status })
                });
                alert(`‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng. Student ID ${data.student_user_id} s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.`);
                getReceivedApplications(); // T·∫£i l·∫°i danh s√°ch
            } catch (e) {
                alert(`‚ùå L·ªói: ${e.message}`);
            }
        }

        // --- STUDENT ACTIONS ---
        async function getAllOpportunities() {
            try {
                // Endpoint: /opportunity/ (map t·ªõi provider-service:8006/api/opportunities/)
                const data = await fetchWithAuth(`${GATEWAY_BASE}/opportunity/`);
                document.getElementById('student-opps').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('student-opps').textContent = `‚ùå L·ªói: ${e.message}`;
            }
        }

        async function submitApplication() {
             try {
                const oppId = document.getElementById('apply-opp-id').value;
                const cvFile = document.getElementById('apply-cv-file').files[0];

                 if (!oppId) {
                    alert('Vui l√≤ng nh·∫≠p Opportunity ID');
                    return;
                }
                
                if (!cvFile) {
                    alert('Vui l√≤ng ch·ªçn file CV');
                    return;
                }

                // S·ª≠ d·ª•ng FormData cho multipart/form-data
                const formData = new FormData();
                formData.append('opportunity_id', oppId);
                formData.append('student_user_id', currentUser.id);
                formData.append('cv_file', cvFile); // T√™n tham s·ªë ph·∫£i kh·ªõp v·ªõi FastAPI (@router.post)

                // Endpoint: /application/ (map t·ªõi application-service:8004/api/applications/)
                // L∆∞u √Ω: fetchWithAuth s·∫Ω kh√¥ng th√™m 'Content-Type: application/json'
                const data = await fetchWithAuth(`${GATEWAY_BASE}/application/`, {
                    method: 'POST',
                    body: formData,
                    headers: {} // Kh√¥ng set Content-Type, tr√¨nh duy·ªát s·∫Ω t·ª± set multipart/form-data
                });

                alert(`‚úÖ N·ªôp h·ªì s∆° th√†nh c√¥ng (ID: ${data.id}). Provider ID ${data.provider_user_id} s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.`);
                getMyApplications(); // T·∫£i l·∫°i danh s√°ch
            } catch (e) {
                alert(`‚ùå L·ªói: ${e.message}`);
            }
        }
        
        async function getMyApplications() {
            try {
                // Endpoint: /application/student/{user_id} (map t·ªõi application-service:8004/api/applications/student/{user_id})
                const data = await fetchWithAuth(`${GATEWAY_BASE}/application/student/${currentUser.id}`);
                document.getElementById('student-apps').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('student-apps').textContent = `‚ùå L·ªói: ${e.message}`;
            }
        }

        // --- DATABASE VIEW ---
        async function getDbNotifications() {
             try {
                // Endpoint: /notification/notifications/{user_id} (map t·ªõi notification-service:8005/api/notifications/{user_id})
                const data = await fetchWithAuth(`${GATEWAY_BASE}/notification/notifications/${currentUser.id}`);
                document.getElementById('db-notifications').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('db-notifications').textContent = `‚ùå L·ªói: ${e.message}`;
            }
        }

        // --- LOAD ON STARTUP ---
        (function() {
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                updateUIForUser();
                connectWebSocket();
            }
        })();
    </script>

</body>
</html>