<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduMatch - Test Platform</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; }
        h1, h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .container { display: flex; gap: 20px; }
        .column { flex: 1; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .section { padding: 15px; border-bottom: 1px solid #eee; }
        .section:last-child { border-bottom: none; }
        input[type="text"], input[type="email"], input[type="password"], select {
            width: calc(100% - 10px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            padding: 8px 12px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; margin-right: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        pre { background: #e9ecef; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; }
        #ws-messages { max-height: 300px; overflow-y: auto; }
        .hidden { display: none; }
        #user-info { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>üöÄ EduMatch - Test Platform (Gateway: <code id="gateway-url"></code>)</h1>

    <div class="container">
        <div class="column">
            <div class="section">
                <h2>1. X√°c th·ª±c (Auth)</h2>
                <div id="login-form">
                    <input type="email" id="login-email" placeholder="Email (e.g., student@email.com)" value="student@email.com">
                    <input type="password" id="login-password" placeholder="Password" value="123456">
                    <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
                    <button classs="secondary" onclick="register()">ƒêƒÉng k√Ω</button>
                </div>
                <div id="user-info" class="hidden">
                    <pre id="user-display"></pre>
                    <button class="danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <div class="section">
                <h2>2. WebSocket (Notification)</h2>
                <div id="ws-status">Ch∆∞a k·∫øt n·ªëi. (H√£y ƒëƒÉng nh·∫≠p)</div>
                <pre id="ws-messages"></pre>
            </div>
        </div>

        <div class="column">
            <div id="provider-section" class="section hidden">
                <h2>3. Provider Actions</h2>
                <div>
                    <strong>T·∫°o Opportunity:</strong><br>
                    <input type="text" id="opp-title" placeholder="Opportunity Title" value="H·ªçc b·ªïng ABC">
                    <input type="text" id="opp-desc" placeholder="Description" value="M√¥ t·∫£ h·ªçc b·ªïng...">
                    <button onclick="createOpportunity()">T·∫°o Opportunity</button>
                </div>
                <hr>
                <div>
                    <strong>Qu·∫£n l√Ω Applications:</strong><br>
                    <button onclick="getReceivedApplications()">Xem h·ªì s∆° ƒë√£ nh·∫≠n</button>
                    <pre id="provider-apps"></pre>
                </div>
                <hr>
                <div>
                    <strong>C·∫≠p nh·∫≠t tr·∫°ng th√°i:</strong><br>
                    <input type="text" id="update-app-id" placeholder="Application ID">
                    <select id="update-status">
                        <option value="viewed">Viewed</option>
                        <option value="interview">Interview</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button onclick="updateAppStatus()">C·∫≠p nh·∫≠t Status</button>
                </div>
            </div>

            <div id="student-section" class="section hidden">
                <h2>4. Student Actions</h2>
                <div>
                    <strong>Xem Opportunities:</strong><br>
                    <button onclick="getAllOpportunities()">Xem t·∫•t c·∫£ Opportunities</button>
                    <pre id="student-opps"></pre>
                </div>
                <hr>
                <div>
                    <strong>N·ªôp Application:</strong><br>
                    <input type="text" id="apply-opp-id" placeholder="Opportunity ID">
                    <button onclick="submitApplication()">N·ªôp Application</button>
                </div>
                <hr>
                <div>
                    <strong>H·ªì s∆° c·ªßa t√¥i:</strong><br>
                    <button onclick="getMyApplications()">Xem h·ªì s∆° ƒë√£ n·ªôp</button>
                    <pre id="student-apps"></pre>
                </div>
            </div>
            
            <div id="common-section" class="section hidden">
                <h2>5. Hi·ªÉn th·ªã Database (Views)</h2>
                 <button onclick="getDbNotifications()">Get My DB Notifications</button>
                 <pre id="db-notifications"></pre>
            </div>
        </div>
    </div>

    <script>
        const GATEWAY_BASE = "http://localhost:8000";
        // C·ªïng 8000 (Gateway) KH√îNG proxy WebSocket.
        // K·∫øt n·ªëi WS tr·ª±c ti·∫øp ƒë·∫øn c·ªïng 8005 c·ªßa Notification Service.
        const WS_NOTIFICATION_SERVICE_BASE = "ws://localhost:8005"; 
        document.getElementById('gateway-url').textContent = GATEWAY_BASE;

        let currentUser = null;
        let ws = null;

        // --- AUTH ---
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                // 1. Login to get token
                const res = await fetch(`${GATEWAY_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Login failed');
                
                localStorage.setItem('token', data.access_token);
                
                // 2. Verify token to get user info
                await fetchUserData(data.access_token);

            } catch (e) {
                logMessage('ws-messages', `Auth Error: ${e.message}`, 'error');
            }
        }
        
        async function register() {
            // T∆∞∆°ng t·ª± login, nh∆∞ng d√πng /auth/register
            alert('Ch·ª©c nƒÉng ƒëƒÉng k√Ω ch∆∞a ƒë∆∞·ª£c th√™m v√†o UI n√†y. Vui l√≤ng d√πng t·ªáp auth/index.html ƒë·ªÉ ƒëƒÉng k√Ω, ho·∫∑c ƒë·∫£m b·∫£o user ƒë√£ t·ªìn t·∫°i.');
        }

        async function fetchUserData(token) {
             try {
                const res = await fetch(`${GATEWAY_BASE}/auth/verify-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Verify failed');

                currentUser = {
                    id: data.user_id,
                    email: data.email,
                    role: data.role,
                    token: token
                };
                localStorage.setItem('user', JSON.stringify(currentUser));
                updateUIForUser();
                connectWebSocket();
            } catch (e) {
                 logMessage('ws-messages', `Auth Error: ${e.message}`, 'error');
                 logout();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            currentUser = null;
            if (ws) ws.close();
            updateUIForUser();
            logMessage('ws-messages', 'ƒê√£ ƒëƒÉng xu·∫•t.', 'info');
        }

        // --- UI UPDATES ---
        function updateUIForUser() {
            if (currentUser) {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-display').textContent = JSON.stringify(currentUser, null, 2);
                document.getElementById('common-section').classList.remove('hidden');

                if (currentUser.role === 'provider') {
                    document.getElementById('provider-section').classList.remove('hidden');
                    document.getElementById('student-section').classList.add('hidden');
                } else if (currentUser.role === 'student') {
                    document.getElementById('provider-section').classList.add('hidden');
                    document.getElementById('student-section').classList.remove('hidden');
                }
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('provider-section').classList.add('hidden');
                document.getElementById('student-section').classList.add('hidden');
                document.getElementById('common-section').classList.add('hidden');
            }
        }

        // --- WEBSOCKET ---
        function connectWebSocket() {
            if (!currentUser) return;
            if (ws) ws.close();

            // Endpoint: /ws/{user_id} (t·ª´ notification-service/main.py)
            const wsUrl = `${WS_NOTIFICATION_SERVICE_BASE}/ws/${currentUser.id}`;
            ws = new WebSocket(wsUrl);
            
            const wsStatus = document.getElementById('ws-status');
            
            ws.onopen = () => {
                wsStatus.textContent = `‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket cho user ${currentUser.id} (t·∫°i ${wsUrl})`;
                logMessage('ws-messages', `[WS] Connected to ${wsUrl}`, 'success');
            };
            ws.onmessage = (event) => {
                logMessage('ws-messages', `[WS] RECV: ${event.data}`, 'info');
            };
            ws.onerror = (event) => {
                wsStatus.textContent = '‚ùå L·ªói WebSocket.';
                logMessage('ws-messages', `[WS] Error: ${JSON.stringify(event)}`, 'error');
            };
            ws.onclose = () => {
                wsStatus.textContent = 'üîå ƒê√£ ng·∫Øt k·∫øt n·ªëi WebSocket.';
                logMessage('ws-messages', '[WS] Disconnected.', 'error');
                ws = null;
            };
        }

        // --- API HELPERS ---
        async function fetchWithAuth(url, options = {}) {
            if (!currentUser) throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p');
            
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.token}`,
                ...options.headers,
            };

            const res = await fetch(url, { ...options, headers });
            const text = await res.text();
            
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                data = { raw: text };
            }

            if (!res.ok) {
                throw new Error(data.detail || data.raw || `HTTP Error ${res.status}`);
            }
            return data;
        }
        
        function logMessage(preId, message, type = 'info') {
            const pre = document.getElementById(preId);
            const line = document.createElement('div');
            line.textContent = message;
            if (type === 'error') line.style.color = 'red';
            if (type === 'success') line.style.color = 'green';
            pre.appendChild(line);
            pre.scrollTop = pre.scrollHeight;
        }

        // --- PROVIDER ACTIONS ---
        async function createOpportunity() {
            try {
                const title = document.getElementById('opp-title').value;
                const description = document.getElementById('opp-desc').value;
                
                // Endpoint: /opportunity/ (map t·ªõi provider-service:8006/api/opportunities/)
                const data = await fetchWithAuth(`${GATEWAY_BASE}/opportunity/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        provider_user_id: currentUser.id,
                        title: title,
                        description: description,
                        type: "scholarship" 
                    })
                });
                alert(`T·∫°o th√†nh c√¥ng Opportunity ID: ${data.id}`);
            } catch (e) {
                alert(`L·ªói: ${e.message}`);
            }
        }
        
        async function getReceivedApplications() {
             try {
                // Endpoint: /provider_app/provider/{user_id} (map t·ªõi provider-service:8006/api/applications/provider/{user_id})
                const data = await fetchWithAuth(`${GATEWAY_BASE}/provider_app/provider/${currentUser.id}`);
                document.getElementById('provider-apps').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('provider-apps').textContent = `L·ªói: ${e.message}`;
            }
        }
        
        async function updateAppStatus() {
            try {
                const appId = document.getElementById('update-app-id').value;
                const status = document.getElementById('update-status').value;
                if (!appId) {
                    alert('Vui l√≤ng nh·∫≠p Application ID');
                    return;
                }
                
                // Endpoint: /provider_app/{app_id}/status (map t·ªõi provider-service:8006/api/applications/{app_id}/status)
                const data = await fetchWithAuth(`${GATEWAY_BASE}/provider_app/${appId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: status })
                });
                alert(`C·∫≠p nh·∫≠t th√†nh c√¥ng. Student ID ${data.student_user_id} s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.`);
                getReceivedApplications(); // T·∫£i l·∫°i danh s√°ch
            } catch (e) {
                alert(`L·ªói: ${e.message}`);
            }
        }

        // --- STUDENT ACTIONS ---
        async function getAllOpportunities() {
            try {
                // Endpoint: /opportunity/ (map t·ªõi provider-service:8006/api/opportunities/)
                const data = await fetchWithAuth(`${GATEWAY_BASE}/opportunity/`);
                document.getElementById('student-opps').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('student-opps').textContent = `L·ªói: ${e.message}`;
            }
        }

        async function submitApplication() {
             try {
                const oppId = document.getElementById('apply-opp-id').value;
                 if (!oppId) {
                    alert('Vui l√≤ng nh·∫≠p Opportunity ID');
                    return;
                }

                // Endpoint: /application/ (map t·ªõi application-service:8004/api/applications/)
                const data = await fetchWithAuth(`${GATEWAY_BASE}/application/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        opportunity_id: parseInt(oppId),
                        student_user_id: currentUser.id,
                        documents: [
                            { document_type: "CV", document_url: "http://example.com/cv.pdf" },
                            { document_type: "Transcript", document_url: "http://example.com/transcript.pdf" }
                        ]
                    })
                });
                alert(`N·ªôp h·ªì s∆° th√†nh c√¥ng (ID: ${data.id}). Provider ID ${data.provider_user_id} s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.`);
                getMyApplications(); // T·∫£i l·∫°i danh s√°ch
            } catch (e) {
                alert(`L·ªói: ${e.message}`);
            }
        }
        
        async function getMyApplications() {
            try {
                // Endpoint: /application/student/{user_id} (map t·ªõi application-service:8004/api/applications/student/{user_id})
                const data = await fetchWithAuth(`${GATEWAY_BASE}/application/student/${currentUser.id}`);
                document.getElementById('student-apps').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('student-apps').textContent = `L·ªói: ${e.message}`;
            }
        }

        // --- DATABASE VIEW ---
        async function getDbNotifications() {
             try {
                // Endpoint: /notification/notifications/{user_id} (map t·ªõi notification-service:8005/api/notifications/{user_id})
                const data = await fetchWithAuth(`${GATEWAY_BASE}/notification/notifications/${currentUser.id}`);
                document.getElementById('db-notifications').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('db-notifications').textContent = `L·ªói: ${e.message}`;
            }
        }

        // --- LOAD ON STARTUP ---
        (function() {
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                updateUIForUser();
                connectWebSocket();
            }
        })();
    </script>

</body>
</html>