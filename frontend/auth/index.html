<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auth Service Tester</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f8f9fa;
    }
    h1 {
      color: #333;
    }
    form {
      margin-bottom: 25px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background-color: #fff;
      width: 350px;
    }
    label {
      display: inline-block;
      width: 90px;
    }
    input {
      width: 200px;
      padding: 5px;
      margin: 5px 0;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
    }
    pre {
      background: #eee;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>üîê Auth Service Test (qua Gateway)</h1>
  <p>
    <small>
      API Base: <code id="api-base"></code>
      <button id="check-backend" style="margin-left:8px; background:#28a745">Ki·ªÉm tra backend</button>
    </small>
  </p>

  <!-- Register -->
  <form id="register-form">
    <h3>Register</h3>
    <label>Email:</label><input type="email" id="reg-email" required><br>
    <label>Password:</label><input type="password" id="reg-password" required><br>
    <label>Role:</label><input type="text" id="reg-role" placeholder="student/provider/admin" required><br>
    <button type="submit">Register</button>
  </form>

  <!-- Login -->
  <form id="login-form">
    <h3>Login</h3>
    <label>Email:</label><input type="email" id="login-email" required><br>
    <label>Password:</label><input type="password" id="login-password" required><br>
    <button type="submit">Login</button>
  </form>

  <!-- Verify Token -->
  <form id="verify-form">
    <h3>Verify Token</h3>
    <label>Token:</label><input type="text" id="verify-token" required><br>
    <button type="submit">Verify</button>
  </form>

  <!-- Get Users -->
  <form id="users-form">
    <h3>Get All Users</h3>
    <button type="submit">Get Users</button>
  </form>

  <div id="result"></div>

  <script>
    const result = document.getElementById("result");
    const BASE = localStorage.getItem("api_base") || "http://localhost:8000/auth"; // g·ªçi qua gateway
    document.getElementById("api-base").textContent = BASE;

    document.getElementById("check-backend").addEventListener("click", async () => {
      try {
        const res = await fetch(`${BASE}/`);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        alert("‚úÖ Backend reachable");
      } catch (e) {
        alert("‚ùå Backend kh√¥ng truy c·∫≠p ƒë∆∞·ª£c. H√£y ƒë·∫£m b·∫£o docker compose ƒëang ch·∫°y v√† c·ªïng 8000 m·ªü.");
      }
    });

    // --- REGISTER ---
    document.getElementById("register-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("reg-email").value;
      const password = document.getElementById("reg-password").value;
      const role = document.getElementById("reg-role").value;
      try {
        const res = await fetch(`${BASE}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, role }),
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        if (!res.ok) {
          alert(`‚ùå Register failed: ${data?.detail || res.status}`);
        }
        result.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      } catch (err) {
        result.textContent = `‚ö†Ô∏è Cannot connect to backend! ${err?.message || ""}`;
      }
    });

    // --- LOGIN ---
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
        const res = await fetch(`${BASE}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        if (!res.ok) {
          alert(`‚ùå Login failed: ${data?.detail || res.status}`);
        } else {
          result.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          if (data.access_token) {
            localStorage.setItem("token", data.access_token);
            // chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß frontend
            window.location.href = "../index.html";
          }
        }
      } catch (err) {
        result.textContent = `‚ö†Ô∏è Cannot connect to backend! ${err?.message || ""}`;
      }
    });

    // --- VERIFY TOKEN ---
    document.getElementById("verify-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = document.getElementById("verify-token").value || localStorage.getItem("token");
      try {
        const res = await fetch(`${BASE}/verify-token`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token }),
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        if (!res.ok) {
          alert(`‚ùå Verify failed: ${data?.detail || res.status}`);
        }
        result.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      } catch (err) {
        result.textContent = `‚ö†Ô∏è Cannot connect to backend! ${err?.message || ""}`;
      }
    });

    // --- GET USERS ---
    document.getElementById("users-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`${BASE}/users`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        if (!res.ok) {
          alert(`‚ùå Get users failed: ${data?.detail || res.status}`);
        }
        result.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      } catch (err) {
        result.textContent = `‚ö†Ô∏è Cannot connect to backend! ${err?.message || ""}`;
      }
    });

    // Th√¥ng tin DB (ch·ªâ l√† m√¥ t·∫£ n∆°i DB ch·∫°y, kh√¥ng ph·∫£i l·ªói)
    const dbInfo = document.createElement('div');
    dbInfo.style.marginTop = '16px';
    dbInfo.innerHTML = `<small>Th√¥ng tin DB (Auth) ƒëang ch·∫°y trong Docker: service <b>postgres-auth</b>, DB: <b>auth_db</b>, user: <b>postgres</b>. K·∫øt n·ªëi n·ªôi b·ªô service-to-service: <code>postgresql://postgres:12345678@postgres-auth:5432/auth_db</code>. Truy c·∫≠p n√†y kh√¥ng kh·∫£ d·ª•ng t·ª´ tr√¨nh duy·ªát.</small>`;
    document.body.appendChild(dbInfo);
  </script>
</body>
</html>
