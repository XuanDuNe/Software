version: '3.8'

services:
  # API Gateway
  gateway:
    build: ./gateway
    ports:
      - "8000:8000"
    depends_on:
      - auth-service
      - application-service
      - notification-service
      - matching-service
      - provider-service
      - user-service

  # Frontend (React, served by NGINX)
  frontend:
    build:
      context: ./frontend/react
      args:
        VITE_API_BASE_URL: http://gateway:8000
    ports:
      - "8080:80"
    depends_on:
      - gateway

  # Auth Service
  auth-service:
    build: ./services/auth-service
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql://postgres:12345678@postgres-auth:5432/auth_db
    depends_on:
      postgres-auth:
        condition: service_healthy

  postgres-auth:
    image: postgres:15
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 12345678
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10


  # Application Service 
  application-service:
    build: ./services/application-service
    ports:
      - "8004:8004"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres-application:5432/application_db
    depends_on:
      postgres-application:            
        condition: service_healthy   

  postgres-application:
    image: postgres:15
    environment:
      POSTGRES_DB: application_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    healthcheck:                     
      test: ["CMD-SHELL", "pg_isready -U user -d application_db"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Notification Service 
  notification-service:
    build: ./services/notification-service
    ports:
      - "8005:8005"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres-notification:5432/notification_db
      - USER_SERVICE_URL=http://user-service:8002 
    depends_on:
      postgres-notification:         
        condition: service_healthy   
  
  postgres-notification:
    image: postgres:15
    environment:
      POSTGRES_DB: notification_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    healthcheck:                     
      test: ["CMD-SHELL", "pg_isready -U user -d notification_db"]
      interval: 5s
      timeout: 5s
      retries: 10

  provider-service:
    build: ./services/provider-service
    ports:
      - "8006:8006" 
    environment:
      - DATABASE_URL=postgresql://provider_user:provider_pass@postgres-provider:5432/provider_db
      - APPLICATION_SERVICE_URL=http://application-service:8004
      - NOTIFICATION_SERVICE_URL=http://notification-service:8005
      - USER_SERVICE_URL=http://user-service:8002
    depends_on:
      postgres-provider:            
        condition: service_healthy
      application-service:
        condition: service_started 
      notification-service:
        condition: service_started 
      user-service:
        condition: service_started 

  postgres-provider:
    image: postgres:15
    environment:
      POSTGRES_DB: provider_db
      POSTGRES_USER: provider_user
      POSTGRES_PASSWORD: provider_pass
    healthcheck:                     
      test: ["CMD-SHELL", "pg_isready -U provider_user -d provider_db"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Matching (AI Recommendation) Service
  matching-service:
    build: ./services/matching-service
    ports:
      - "8007:8007"
    environment:
      - PROVIDER_SERVICE_URL=http://provider-service:8006
    depends_on:
      provider-service:
        condition: service_started

  user-service:
    build: ./services/user-service
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres-user:5432/user_db
    depends_on:
      postgres-user:
        condition: service_healthy

  postgres-user:
    image: postgres:15
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d user_db"]
      interval: 5s
      timeout: 5s
      retries: 10